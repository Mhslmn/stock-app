const APP_ID="ncekn7VRIJNsmirVuvocKRhznshe4Zn0mD68ipB3",JS_KEY="oikoKqNjQ2PaDRRuP8ZL1fUcnoghOjnzwTS2sFLD",REST_KEY="WrV8d6K53Huo5PR4VYi8ZnOjINEexK9Onpp5Lcqg",headers={"X-Parse-Application-Id":"ncekn7VRIJNsmirVuvocKRhznshe4Zn0mD68ipB3","X-Parse-JavaScript-Key":"oikoKqNjQ2PaDRRuP8ZL1fUcnoghOjnzwTS2sFLD","X-Parse-REST-API-Key":"WrV8d6K53Huo5PR4VYi8ZnOjINEexK9Onpp5Lcqg","Content-Type":"application/json"};let systemSettings={adminPassword:"1234",masterPassword:"master123",penaltyRules:[{maxDelay:0,penalty:0},{maxDelay:5,penalty:-500},{maxDelay:10,penalty:-1e3},{maxDelay:20,penalty:-2e3},{maxDelay:30,penalty:-3e3},{maxDelay:9999,penalty:-4e3}],absentPenalty:-5e3,dailyReward:1e4,tax:1e3};const cache={assets:null,persons:null,settings:null,attendance:null},loginSection=document.getElementById("loginSection"),mainSection=document.getElementById("mainSection"),masterPasswordModal=document.getElementById("masterPasswordModal");async function loadSystemSettings(){try{let e=await fetch("https://parseapi.back4app.com/classes/SystemSettings",{headers}),t=await e.json();if(t.results.length>0){let s=t.results[0];systemSettings={...systemSettings,adminPassword:s.adminPassword,masterPassword:s.masterPassword,dailyReward:s.dailyReward||1e4,tax:s.tax||1e3,absentPenalty:s.absentPenalty||-5e3}}}catch(a){console.error("Error loading settings:",a)}}async function handleLogin(){let e=document.getElementById("accessCode").value;try{let t=await fetch("https://parseapi.back4app.com/classes/SystemSettings",{headers}),s=await t.json();if(s.results.length>0){let a=s.results[0];systemSettings={...systemSettings,adminPassword:a.adminPassword,masterPassword:a.masterPassword},e===a.adminPassword?(localStorage.setItem("loggedIn","true"),loginSection.classList.add("hidden"),mainSection.classList.remove("hidden"),init(),showAlert("ورود با موفقیت انجام شد","success")):showAlert("کد ورود نامعتبر است","danger")}else e===systemSettings.adminPassword?(localStorage.setItem("loggedIn","true"),loginSection.classList.add("hidden"),mainSection.classList.remove("hidden"),init(),showAlert("ورود با موفقیت انجام شد","success")):showAlert("کد ورود نامعتبر است","danger")}catch(n){console.error("Error loading system settings:",n),showAlert("خطا در ارتباط با سرور","danger")}}async function init(){await Promise.all([fetchAssets(),fetchPersons(),loadPenaltyRules(),loadRewardSettings()]),await populateAllGroupSelects(),await loadTodaysRecords()}async function fetchAssets(){try{let[e,t]=await Promise.all([fetch("https://parseapi.back4app.com/classes/Assets",{headers}),fetch("https://parseapi.back4app.com/classes/Persons",{headers})]),s=await e.json(),a=await t.json(),n={};a.results.forEach(e=>{n[e.group]=(n[e.group]||0)+1});let r=s.results.map(e=>({...e,memberCount:n[e.name]||0}));cache.assets=r,renderAssetsTable(),showAlert("اطلاعات دارایی با موفقیت به‌روزرسانی شد","success")}catch(l){console.error("Error fetching assets:",l),showAlert("خطا در دریافت اطلاعات دارایی","danger")}}async function fetchPersons(){try{let e=await fetch("https://parseapi.back4app.com/classes/Persons",{headers}),t=await e.json();return cache.persons=t.results,cache.persons}catch(s){return console.error("Error fetching persons:",s),showAlert("خطا در دریافت لیست اعضا","danger"),[]}}function renderAssetsTable(){let e=document.querySelector("#assetTable tbody");if(e.innerHTML="",!cache.assets||0===cache.assets.length){e.innerHTML=`<tr><td colspan="3" class="text-center">داده‌ای موجود نیست</td></tr>`;return}cache.assets.forEach(t=>{let s=new Intl.NumberFormat("fa-IR").format(t.amount);e.innerHTML+=`
      <tr>
        <td>${t.name}</td>
        <td>${s}</td>
        <td>${t.memberCount}</td>
      </tr>
    `})}async function populateAllGroupSelects(){cache.assets||await fetchAssets();let e=cache.assets.map(e=>e.name);["groupSelect","groupForAttendance","memberGroupSelect","memberListGroupSelect"].forEach(t=>{let s=document.getElementById(t);s.innerHTML="",e.forEach(e=>{let t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)})}),updateCurrentAssetDisplay()}async function updateCurrentAssetDisplay(){let e=document.getElementById("groupSelect"),t=e.value;if(!t)return;cache.assets||await fetchAssets();let s=cache.assets.find(e=>e.name===t);if(s){let a=new Intl.NumberFormat("fa-IR").format(s.amount);document.getElementById("currentAsset").innerHTML=`
      <i class="fas fa-info-circle"></i>
      دارایی فعلی گروه ${t}: ${a} تومان
    `}}async function changeAsset(e){let t=document.getElementById("groupSelect").value,s=document.getElementById("amountInput"),a=parseInt(s.value);if(!t){showAlert("لطفاً یک گروه انتخاب کنید","danger");return}if(!a||a<=0){showAlert("مقدار نامعتبر است. لطفاً یک عدد مثبت وارد کنید","danger");return}try{let n=cache.assets.find(e=>e.name===t);if(!n){showAlert("گروه مورد نظر یافت نشد","danger");return}let r=n.amount+(e?a:-a);await fetch(`https://parseapi.back4app.com/classes/Assets/${n.objectId}`,{method:"PUT",headers,body:JSON.stringify({amount:r})}),n.amount=r,showAlert(`دارایی گروه ${t} با موفقیت بروزرسانی شد`,"success"),renderAssetsTable(),updateCurrentAssetDisplay(),s.value=""}catch(l){console.error("Error changing asset:",l),showAlert("خطا در بروزرسانی دارایی","danger")}}async function addGroup(){let e=document.getElementById("newGroupName"),t=e.value.trim();if(!t){showAlert("لطفاً نام گروه را وارد کنید","danger");return}try{if(cache.assets&&cache.assets.some(e=>e.name===t)){showAlert("گروه با این نام قبلاً ایجاد شده است","danger");return}let s=await fetch("https://parseapi.back4app.com/classes/Assets",{method:"POST",headers,body:JSON.stringify({name:t,amount:0})}),a=await s.json();cache.assets||(cache.assets=[]),cache.assets.push({...a,memberCount:0}),e.value="",showAlert(`گروه ${t} با موفقیت ایجاد شد`,"success"),await populateAllGroupSelects()}catch(n){console.error("Error adding group:",n),showAlert("خطا در ایجاد گروه جدید","danger")}}async function removeGroup(){let e=document.getElementById("newGroupName"),t=e.value.trim();if(!t){showAlert("لطفاً نام گروه را وارد کنید","danger");return}try{let s=cache.assets.findIndex(e=>e.name===t);if(-1===s){showAlert("گروه مورد نظر یافت نشد","danger");return}let a=cache.assets[s],n=cache.persons.filter(e=>e.group===t),r=n.map(e=>fetch(`https://parseapi.back4app.com/classes/Persons/${e.objectId}`,{method:"DELETE",headers}));await Promise.all(r),await fetch(`https://parseapi.back4app.com/classes/Assets/${a.objectId}`,{method:"DELETE",headers}),cache.assets.splice(s,1),cache.persons=cache.persons.filter(e=>e.group!==t),e.value="",showAlert(`گروه ${t} و تمام اعضای آن با موفقیت حذف شد`,"success"),await populateAllGroupSelects(),await loadMembers(),renderAssetsTable()}catch(l){console.error("Error removing group:",l),showAlert("خطا در حذف گروه","danger")}}async function populateAttendance(){let e=document.getElementById("groupForAttendance").value;if(!e){showAlert("لطفاً یک گروه انتخاب کنید","danger");return}cache.persons||await fetchPersons();let t=cache.persons.filter(t=>t.group===e),s=`
    <div style="margin: 1rem 0; font-weight: bold; text-align: center; color: var(--primary);">
      اعضای گروه ${e}
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>نام عضو</th>
          <th>تاخیر (دقیقه)</th>
          <th>غیبت</th>
          <th>حضور</th>
        </tr>
      </thead>
      <tbody>`;0===t.length?s+=`<tr><td colspan="4" class="text-center">هیچ عضوی در این گروه یافت نشد</td></tr>`:t.forEach(e=>{s+=`
        <tr>
          <td>${e.name}</td>
          <td>
            <input type="number" 
                   id="delay-${e.objectId}" 
                   placeholder="0"
                   min="0"
                   class="form-control"
                   style="max-width: 120px; margin: 0 auto;">
          </td>
          <td class="text-center">
            <button onclick="markAbsent('${e.objectId}', '${e.name}')" 
                    class="btn btn-danger"
                    style="padding: 8px 12px;">
              <i class="fas fa-user-times"></i>
              غیبت
            </button>
          </td>
          <td class="text-center">
            <button onclick="submitAttendance('${e.objectId}')" 
                    class="btn btn-success"
                    style="padding: 8px 12px;">
              <i class="fas fa-user-check"></i>
             حضور
            </button>
          </td>
        </tr>`}),s+="</tbody></table>",document.getElementById("attendanceTable").innerHTML=s}async function submitAttendance(e){let t=document.getElementById(`delay-${e}`),s=t.value?parseInt(t.value):0;if(isNaN(s)||s<0){showAlert("لطفاً زمان تأخیر را به صورت عدد صحیح وارد کنید","danger");return}let a=calculatePenalty(s);try{let n=cache.persons.find(t=>t.objectId===e);if(!n){showAlert("عضو مورد نظر یافت نشد","danger");return}let r=n.group,l=cache.assets.find(e=>e.name===r);if(!l){showAlert("گروه مربوطه یافت نشد","danger");return}let o=l.amount+a;await fetch(`https://parseapi.back4app.com/classes/Assets/${l.objectId}`,{method:"PUT",headers,body:JSON.stringify({amount:o})}),l.amount=o,await fetch("https://parseapi.back4app.com/classes/Attendance",{method:"POST",headers,body:JSON.stringify({person:{__type:"Pointer",className:"Persons",objectId:e},personName:n.name,group:r,status:"حاضر",delay:s,penalty:a,date:new Date().toISOString().split("T")[0]})}),showAlert(`حضور ${n.name} ثبت شد. ${Math.abs(a)} تومان ${a<0?"جریمه":"پاداش"} اعمال شد`,"success"),renderAssetsTable(),loadTodaysRecords(),t.value=""}catch(d){console.error("Error submitting attendance:",d),showAlert("خطا در ثبت حضور","danger")}}async function markAbsent(e,t){let s=systemSettings.absentPenalty;try{let a=cache.persons.find(t=>t.objectId===e);if(!a){showAlert("عضو مورد نظر یافت نشد","danger");return}let n=a.group,r=cache.assets.find(e=>e.name===n);if(!r){showAlert("گروه مربوطه یافت نشد","danger");return}let l=r.amount+s;await fetch(`https://parseapi.back4app.com/classes/Assets/${r.objectId}`,{method:"PUT",headers,body:JSON.stringify({amount:l})}),r.amount=l,await fetch("https://parseapi.back4app.com/classes/Attendance",{method:"POST",headers,body:JSON.stringify({person:{__type:"Pointer",className:"Persons",objectId:e},personName:t,group:n,status:"غایب",delay:-1,penalty:s,date:new Date().toISOString().split("T")[0]})}),showAlert(`غیبت ${t} ثبت شد. ۵,۰۰۰ تومان جریمه اعمال شد`,"success"),renderAssetsTable(),loadTodaysRecords()}catch(o){console.error("Error marking absent:",o),showAlert("خطا در ثبت غیبت","danger")}}function calculatePenalty(e){if(-1===e)return systemSettings.absentPenalty;for(let t of systemSettings.penaltyRules)if(e<=t.maxDelay)return t.penalty;return systemSettings.penaltyRules[systemSettings.penaltyRules.length-1].penalty}async function loadTodaysRecords(){try{let e=new Date().toISOString().split("T")[0],t=await fetch(`https://parseapi.back4app.com/classes/Attendance?where=${encodeURIComponent(JSON.stringify({date:e}))}`,{headers}),s=await t.json(),a=document.querySelector("#attendanceRecordsTable tbody");if(a.innerHTML="",0===s.results.length){a.innerHTML=`<tr><td colspan="6" class="text-center">هیچ رکوردی برای امروز ثبت نشده است</td></tr>`;return}s.results.forEach(e=>{let t="status-present",s="حاضر";"غایب"===e.status?(t="status-absent",s="غایب"):e.delay>0&&(t="status-late",s="تأخیر");let n=new Intl.NumberFormat("fa-IR").format(e.penalty),r=e.personName||"نامشخص";a.innerHTML+=`
        <tr>
          <td>${r}</td>
          <td>${e.group}</td>
          <td class="${t}">${s}</td>
          <td>${e.delay>=0?e.delay:"۰"}</td>
          <td>${n}</td>
          <td class="text-center">
            <button onclick="deleteAttendanceRecord('${e.objectId}', '${r}', ${e.penalty})" 
                    class="btn btn-danger"
                    style="padding: 6px 10px;">
              <i class="fas fa-trash-alt"></i>
              حذف
            </button>
          </td>
        </tr>
      `})}catch(n){console.error("Error loading attendance records:",n),showAlert("خطا در دریافت سوابق حضور و غیاب","danger")}}async function deleteAttendanceRecord(e,t,s){if(confirm(`آیا مطمئن هستید که می‌خواهید رکورد ${t} را حذف کنید؟`))try{let a=await fetch(`https://parseapi.back4app.com/classes/Attendance/${e}`,{headers}),n=await a.json(),r=cache.assets.find(e=>e.name===n.group);if(r){let l=r.amount-s;await fetch(`https://parseapi.back4app.com/classes/Assets/${r.objectId}`,{method:"PUT",headers,body:JSON.stringify({amount:l})}),r.amount=l}await fetch(`https://parseapi.back4app.com/classes/Attendance/${e}`,{method:"DELETE",headers}),showAlert(`رکورد ${t} با موفقیت حذف شد`,"success"),renderAssetsTable(),loadTodaysRecords()}catch(o){console.error("Error deleting attendance record:",o),showAlert("خطا در حذف رکورد","danger")}}async function addMember(){let e=document.getElementById("newMemberName"),t=e.value.trim(),s=document.getElementById("memberGroupSelect").value;if(!t){showAlert("لطفاً نام عضو را وارد کنید","danger");return}if(!s){showAlert("لطفاً یک گروه انتخاب کنید","danger");return}try{if(cache.persons&&cache.persons.some(e=>e.name===t&&e.group===s)){showAlert("این عضو قبلاً در گروه ثبت شده است","danger");return}let a=await fetch("https://parseapi.back4app.com/classes/Persons",{method:"POST",headers,body:JSON.stringify({name:t,group:s})}),n=await a.json();cache.persons||(cache.persons=[]),cache.persons.push(n);let r=cache.assets.find(e=>e.name===s);r&&(r.memberCount=(r.memberCount||0)+1),e.value="",showAlert(`عضو ${t} با موفقیت به گروه ${s} اضافه شد`,"success"),await loadMembers(),renderAssetsTable()}catch(l){console.error("Error adding member:",l),showAlert("خطا در افزودن عضو جدید","danger")}}async function loadMembers(){let e=document.getElementById("memberListGroupSelect").value;cache.persons||await fetchPersons();let t=cache.persons;e&&(t=t.filter(t=>t.group===e));let s=document.querySelector("#membersTable tbody");if(s.innerHTML="",0===t.length){s.innerHTML=`<tr><td colspan="3" class="text-center">هیچ عضوی یافت نشد</td></tr>`;return}t.forEach(e=>{s.innerHTML+=`
      <tr>
        <td>${e.name}</td>
        <td>${e.group}</td>
        <td class="text-center">
          <button onclick="deleteMember('${e.objectId}', '${e.name}')" 
                  class="btn btn-danger"
                  style="padding: 6px 10px;">
            <i class="fas fa-trash-alt"></i>
            حذف
          </button>
        </td>
      </tr>
    `})}async function deleteMember(e,t){if(confirm(`آیا مطمئن هستید که می‌خواهید ${t} را حذف کنید؟`))try{let s=cache.persons.findIndex(t=>t.objectId===e);if(-1===s){showAlert("عضو مورد نظر یافت نشد","danger");return}let a=cache.persons[s],n=a.group;await fetch(`https://parseapi.back4app.com/classes/Persons/${e}`,{method:"DELETE",headers}),cache.persons.splice(s,1);let r=cache.assets.find(e=>e.name===n);r&&(r.memberCount=Math.max((r.memberCount||0)-1,0)),showAlert(`عضو ${t} با موفقیت حذف شد`,"success"),await loadMembers(),renderAssetsTable()}catch(l){console.error("Error deleting member:",l),showAlert("خطا در حذف عضو","danger")}}function showPrintPreview(e,t){let s=document.getElementById(e).cloneNode(!0);s.classList.add("print-table"),document.getElementById("printTitle").textContent=t,document.getElementById("printDate").textContent=new Date().toLocaleDateString("fa-IR"),document.getElementById("printTableContainer").innerHTML="",document.getElementById("printTableContainer").appendChild(s),document.getElementById("printPreview").classList.add("active")}function closePrintPreview(){document.getElementById("printPreview").classList.remove("active")}async function endOfDayProcess(){let e=parseInt(document.getElementById("classCount").value),t=parseInt(document.getElementById("rewardAmount").value),s=parseInt(document.getElementById("taxAmount").value);if(!e||e<=0){showAlert("لطفاً تعداد کلاس‌های برگزار شده را وارد کنید","danger");return}if(!t||t<=0){showAlert("لطفاً مقدار پاداش را وارد کنید","danger");return}try{let a=new Date().toISOString().split("T")[0],n=await fetch(`https://parseapi.back4app.com/classes/Attendance?where=${encodeURIComponent(JSON.stringify({date:a}))}`,{headers}),r=await n.json(),l={};r.results.forEach(e=>{let t=e.person.objectId;l[t]||(l[t]={name:e.personName,group:e.group,presentCount:0,totalCount:0}),l[t].totalCount++,"حاضر"===e.status&&l[t].presentCount++});let o=document.querySelector("#fullAttendanceTable tbody");o.innerHTML="";let d=0;for(let c in l){let i=l[c],m=i.presentCount>=e;if(m){d++;let p=t-s;o.innerHTML+=`
          <tr>
            <td>${i.name}</td>
            <td>${i.group}</td>
            <td>${i.presentCount}</td>
            <td>${new Intl.NumberFormat("fa-IR").format(p)}</td>
          </tr>
        `;let u=cache.assets.find(e=>e.name===i.group);if(u){let y=u.amount+p;await fetch(`https://parseapi.back4app.com/classes/Assets/${u.objectId}`,{method:"PUT",headers,body:JSON.stringify({amount:y})}),u.amount=y}}}let h=r.results.map(e=>fetch(`https://parseapi.back4app.com/classes/Attendance/${e.objectId}`,{method:"DELETE",headers}));await Promise.all(h),showAlert(`پایان روز با موفقیت انجام شد. ${d} عضو واجد شرایط پاداش بودند.`,"success"),renderAssetsTable(),loadTodaysRecords()}catch(g){console.error("Error in end of day process:",g),showAlert("خطا در انجام عملیات پایان روز","danger")}}function updateRulesFromForm(){for(let e=0;e<systemSettings.penaltyRules.length;e++){let t=document.getElementById(`maxDelay${e}`),s=document.getElementById(`penalty${e}`);t&&s&&(t.disabled||(systemSettings.penaltyRules[e].maxDelay=parseInt(t.value)||0),systemSettings.penaltyRules[e].penalty=parseInt(s.value)||0)}}async function loadPenaltyRules(){try{let e=await fetch("https://parseapi.back4app.com/classes/PenaltyRules",{headers}),t=await e.json();t.results.length>0&&(systemSettings.penaltyRules=t.results.map(e=>({maxDelay:e.maxDelay,penalty:e.penalty}))),renderPenaltyRulesTable(),loadPenaltySettings()}catch(s){console.error("Error loading penalty rules:",s)}}function renderPenaltyRulesTable(){let e=document.querySelector("#penaltyRulesTable tbody");e.innerHTML="",systemSettings.penaltyRules.forEach(t=>{let s=new Intl.NumberFormat("fa-IR").format(t.penalty),a=9999===t.maxDelay?"بیش از ۳۰ دقیقه":t.maxDelay;e.innerHTML+=`
      <tr>
        <td>${a}</td>
        <td>${s}</td>
      </tr>
    `})}function loadPenaltySettings(){let e=document.querySelector("#penaltySettingsTable tbody");e.innerHTML="",systemSettings.penaltyRules.forEach((t,s)=>{let a=s===systemSettings.penaltyRules.length-1;e.innerHTML+=`
      <tr>
        <td>
          <input type="number" class="form-control" id="maxDelay${s}" 
                 value="${t.maxDelay}" min="0" ${a?"disabled":""}
                 onchange="handleRuleChange(${s}, 'maxDelay')">
        </td>
        <td>
          <input type="number" class="form-control" id="penalty${s}" 
                 value="${t.penalty}"
                 onchange="handleRuleChange(${s}, 'penalty')">
        </td>
        <td>
          <button class="btn btn-danger" 
                  ${a?"disabled":""}
                  onclick="removeRule(${s})">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `})}function handleRuleChange(e,t){let s=parseInt(document.getElementById(`${t}${e}`).value)||0;"maxDelay"===t?systemSettings.penaltyRules[e].maxDelay=s:systemSettings.penaltyRules[e].penalty=s}function addRule(){let e=systemSettings.penaltyRules.length-2,t=e>=0?{...systemSettings.penaltyRules[e]}:{maxDelay:15,penalty:-1500};t.maxDelay+=5,systemSettings.penaltyRules.splice(systemSettings.penaltyRules.length-1,0,t),loadPenaltySettings()}function removeRule(e){systemSettings.penaltyRules.splice(e,1),loadPenaltySettings()}async function saveRules(){let e=document.getElementById("ruleMasterPassword").value;if(e!==systemSettings.masterPassword){showAlert("رمز ویژه وارد شده صحیح نیست","danger");return}try{updateRulesFromForm();let t=await fetch("https://parseapi.back4app.com/classes/PenaltyRules",{headers}).then(e=>e.json()),s=t.results.map(e=>fetch(`https://parseapi.back4app.com/classes/PenaltyRules/${e.objectId}`,{method:"DELETE",headers}));await Promise.all(s);let a=systemSettings.penaltyRules.map(e=>fetch("https://parseapi.back4app.com/classes/PenaltyRules",{method:"POST",headers,body:JSON.stringify(e)}));await Promise.all(a),showAlert("قوانین با موفقیت ذخیره شدند","success"),renderPenaltyRulesTable(),loadPenaltySettings()}catch(n){console.error("Error saving rules:",n),showAlert("خطا در ذخیره قوانین","danger")}}async function loadRewardSettings(){try{let e=await fetch("https://parseapi.back4app.com/classes/SystemSettings",{headers}),t=await e.json();if(t.results.length>0){let s=t.results[0];document.getElementById("dailyReward").value=s.dailyReward||1e4,document.getElementById("taxAmount").value=s.tax||1e3,document.getElementById("rewardAmount").value=s.dailyReward||1e4,document.getElementById("taxAmountSettings").value=s.tax||1e3,document.getElementById("absentPenalty").value=Math.abs(s.absentPenalty||5e3)}}catch(a){console.error("Error loading reward settings:",a)}}async function saveRewardSettings(){let e=parseInt(document.getElementById("dailyReward").value)||1e4,t=parseInt(document.getElementById("taxAmountSettings").value)||1e3,s=-Math.abs(parseInt(document.getElementById("absentPenalty").value))||-5e3;try{let a=await fetch("https://parseapi.back4app.com/classes/SystemSettings",{headers}),n=await a.json(),r;if(n.results.length>0){let l=n.results[0];r=fetch(`https://parseapi.back4app.com/classes/SystemSettings/${l.objectId}`,{method:"PUT",headers,body:JSON.stringify({dailyReward:e,tax:t,absentPenalty:s})})}else r=fetch("https://parseapi.back4app.com/classes/SystemSettings",{method:"POST",headers,body:JSON.stringify({adminPassword:systemSettings.adminPassword,masterPassword:systemSettings.masterPassword,dailyReward:e,tax:t,absentPenalty:s})});await r,systemSettings.dailyReward=e,systemSettings.tax=t,systemSettings.absentPenalty=s,showAlert("تنظیمات پاداش و مالیات با موفقیت ذخیره شد","success")}catch(o){console.error("Error saving reward settings:",o),showAlert("خطا در ذخیره تنظیمات","danger")}}function showAlert(e,t){let s=document.createElement("div");s.className=`alert alert-${t}`,s.innerHTML=`
    <i class="fas fa-${"success"===t?"check-circle":"exclamation-circle"}"></i>
    ${e}
  `;let a=document.querySelector(".container");a&&a.prepend(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},5e3)}function switchTab(e){document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".tab").forEach(e=>{e.classList.remove("active")}),document.getElementById(`${e}Tab`).classList.add("active"),document.querySelectorAll(".tab").forEach(t=>{t.textContent.trim()===document.querySelector(`#${e}Tab .card-title`).textContent.trim()&&t.classList.add("active")})}function logout(){localStorage.removeItem("loggedIn"),loginSection.classList.remove("hidden"),mainSection.classList.add("hidden"),document.getElementById("accessCode").value="",showAlert("با موفقیت از سیستم خارج شدید","success")}function showMasterPasswordModal(){masterPasswordModal.style.display="flex"}function closeMasterPasswordModal(){masterPasswordModal.style.display="none",document.getElementById("masterPassword").value="",document.getElementById("newMainPassword").value="",document.getElementById("confirmMainPassword").value=""}async function changeMainPassword(){let e=document.getElementById("masterPassword").value,t=document.getElementById("newMainPassword").value,s=document.getElementById("confirmMainPassword").value;if(e!==systemSettings.masterPassword){showAlert("رمز ویژه وارد شده صحیح نیست","danger");return}if(t!==s){showAlert("رمزهای عبور جدید با هم مطابقت ندارند","danger");return}if(t.length<4){showAlert("رمز عبور باید حداقل ۴ کاراکتر باشد","danger");return}try{let a=await fetch("https://parseapi.back4app.com/classes/SystemSettings",{headers}),n=await a.json();if(n.results.length>0){let r=n.results[0];await fetch(`https://parseapi.back4app.com/classes/SystemSettings/${r.objectId}`,{method:"PUT",headers,body:JSON.stringify({adminPassword:t})})}systemSettings.adminPassword=t,showAlert("رمز عبور اصلی با موفقیت تغییر یافت","success"),closeMasterPasswordModal()}catch(l){console.error("Error changing password:",l),showAlert("خطا در تغییر رمز عبور","danger")}}async function changeAdminPassword(){let e=document.getElementById("currentMasterPassword").value,t=document.getElementById("newAdminPassword").value,s=document.getElementById("confirmAdminPassword").value;if(e!==systemSettings.masterPassword){showAlert("رمز ویژه وارد شده صحیح نیست","danger");return}if(t!==s){showAlert("رمزهای عبور جدید با هم مطابقت ندارند","danger");return}if(t.length<4){showAlert("رمز عبور باید حداقل ۴ کاراکتر باشد","danger");return}try{let a=await fetch("https://parseapi.back4app.com/classes/SystemSettings",{headers}),n=await a.json();if(n.results.length>0){let r=n.results[0];await fetch(`https://parseapi.back4app.com/classes/SystemSettings/${r.objectId}`,{method:"PUT",headers,body:JSON.stringify({adminPassword:t})})}systemSettings.adminPassword=t,showAlert("رمز عبور مدیر با موفقیت تغییر یافت","success"),document.getElementById("currentMasterPassword").value="",document.getElementById("newAdminPassword").value="",document.getElementById("confirmAdminPassword").value=""}catch(l){console.error("Error changing password:",l),showAlert("خطا در تغییر رمز عبور","danger")}}document.addEventListener("DOMContentLoaded",()=>{loadSystemSettings(),"true"===localStorage.getItem("loggedIn")&&(loginSection.classList.add("hidden"),mainSection.classList.remove("hidden"),init())}),window.handleLogin=handleLogin,window.logout=logout,window.showMasterPasswordModal=showMasterPasswordModal,window.closeMasterPasswordModal=closeMasterPasswordModal,window.changeMainPassword=changeMainPassword,window.changeAdminPassword=changeAdminPassword,window.switchTab=switchTab,window.fetchAssets=fetchAssets,window.updateCurrentAssetDisplay=updateCurrentAssetDisplay,window.changeAsset=changeAsset,window.addGroup=addGroup,window.removeGroup=removeGroup,window.populateAttendance=populateAttendance,window.submitAttendance=submitAttendance,window.markAbsent=markAbsent,window.loadTodaysRecords=loadTodaysRecords,window.deleteAttendanceRecord=deleteAttendanceRecord,window.addMember=addMember,window.loadMembers=loadMembers,window.deleteMember=deleteMember,window.showPrintPreview=showPrintPreview,window.closePrintPreview=closePrintPreview,window.endOfDayProcess=endOfDayProcess,window.addRule=addRule,window.removeRule=removeRule,window.saveRules=saveRules,window.saveRewardSettings=saveRewardSettings,window.handleRuleChange=handleRuleChange;